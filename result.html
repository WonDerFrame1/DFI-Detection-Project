<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFI - Detection Result</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --progress-value: 0;
        }
        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            background-color: #05040d; /* Darker background */
            color: white;
            /* overflow: hidden; Removed to allow scrolling on smaller screens if content is long */
        }
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: linear-gradient(to right bottom, #05040d, #06050f, #080611, #090813, #0a0915, #0b0a17, #0c0b19, #0d0c1b, #0f0d1d, #100e1f, #110f21, #121023);
        }
        pre { white-space: pre-wrap; word-wrap: break-word; }

        /* Header Styles for consistency - MADE RESPONSIVE */
        header {
            display: flex;
            flex-direction: column; /* Stack vertically on small screens */
            justify-content: center; /* Center items when stacked */
            align-items: center; /* Center items when stacked */
            color: white;
            padding: 10px 20px; /* Reduced padding for mobile */
            position: relative;
            z-index: 1;
        }
        /* Desktop styles for header */
        @media (min-width: 768px) {
            header {
                flex-direction: row; /* Horizontal layout on desktop */
                justify-content: space-between; /* Space out items */
                padding: 0px 50px 20px 70px; /* Original larger padding */
            }
        }

        .logo img {
            height: 80px; /* Reduced logo size for mobile */
            width: auto;
            margin-bottom: 10px; /* Space below logo on mobile */
        }
        @media (min-width: 768px) {
            .logo img {
                height: 130px; /* Original logo size on desktop */
                margin-bottom: 0;
            }
        }
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 10px; /* Reduced gap for mobile */
            flex-wrap: wrap; /* Allow navigation to wrap on very small screens */
            justify-content: center;
        }
        @media (min-width: 768px) {
            .nav-menu {
                gap: 20px; /* Original gap on desktop */
            }
        }
        .nav-menu nav {
            margin-top: 0; /* Adjusted margin */
        }
        .nav-menu nav a {
            margin: 0 5px; /* Reduced link margin for mobile */
            color: #ffffff;
            text-decoration: none;
            font-size: 0.9rem; /* Smaller font for mobile */
        }
        @media (min-width: 768px) {
            .nav-menu nav a {
                margin: 0 10px; /* Original link margin on desktop */
                font-size: 1rem;
            }
        }
        .nav-menu nav a.active {
            font-weight: bold;
        }

        /* Original UI styles */
        .circular-progress {
            width: 150px; height: 150px; /* Slightly smaller for mobile */
            border-radius: 50%; display: grid; place-items: center;
            background: radial-gradient(closest-side, #0f0c1f 85%, transparent 86% 100%),
            conic-gradient(var(--progress-color, #ff4d6d) calc(var(--progress-value) * 1%), #444 0);
            position: relative; transition: background 0.5s ease;
        }
        @media (min-width: 768px) {
            .circular-progress {
                width: 180px; height: 180px; /* Original size on desktop */
            }
        }
        .progress-value { font-size: 2.5em; font-weight: bold; color: #fff; }
        @media (min-width: 768px) {
             .progress-value { font-size: 3em; }
        }

        /* Feedback Modal Styles */
        .feedback-yn-btn.active {
            background-color: white;
            font-weight: bold;
        }
        .feedback-yn-btn[data-value="Yes"] svg {
            stroke: #2ecc71; /* Green color for check mark */
        }
        .feedback-yn-btn[data-value="No"] svg {
            stroke: #ff4d6d; /* Red color for cross mark */
        }
        #star-rating span {
            color: #9ca3af; /* Lighter grey for stars */
            font-size: 2rem; /* Adjusted for mobile */
        }
        @media (min-width: 768px) {
             #star-rating span { font-size: 2.5rem; }
        }
        #star-rating span.hovered, #star-rating span.active {
            color: #fdd835; /* Gold/yellow color for stars */
        }
        .feedback-content::-webkit-scrollbar {
            width: 6px;
        }
        .feedback-content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        #check-another-btn, #send-feedback-btn:not(:disabled) {
            background: linear-gradient(to right, #56ccf2, #2f80ed);
            color: white;
            transition: all 0.3s ease-in-out;
        }
        #check-another-btn:hover, #send-feedback-btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(47, 128, 237, 0.4);
        }
        #send-feedback-btn:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="min-h-screen">
    <canvas id="bg-canvas"></canvas>
    <header>
        <a href="index.html">
            <div class="logo">
                <img src="imge/Logo 1.png" alt="DFI Logo" onerror="this.onerror=null;this.src='https://placehold.co/200x80/0f0c1f/ffffff?text=DFI';">
            </div>
        </a>
        <div class="nav-menu">
            <nav>
                <a href="introduction.html">Introduction</a>
                <a href="image-detection.html">Image Detection</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="about us.html">About Us</a>
            </nav>
        </div>
    </header>

    <main class="w-full flex-1 flex items-center justify-center p-4 md:p-8">
        <div id="result-wrapper" class="w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            
            <div class="result-image-panel flex flex-col items-center justify-center order-1"> <img id="final-image" src="" alt="Analyzed image" class="w-full max-h-80 md:max-h-96 object-contain rounded-2xl bg-white/5 p-2 mb-6">
                <button id="check-another-btn" class="font-bold py-3 px-8 rounded-full transition-all duration-300">
                    Check another image
                </button>
            </div>

            <div id="result-details" class="result-details-panel flex flex-col items-center w-full order-2">
                </div>
        </div>
    </main>

    <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 transition-opacity duration-300 p-4">
        <div class="flex flex-col items-end w-full max-w-md md:max-w-2xl">
              <div class="feedback-content bg-white/10 backdrop-blur-md rounded-2xl p-6 md:p-8 w-full text-white border border-gray-700 max-h-[90vh] md:max-h-[80vh] overflow-y-auto">
                <h2 class="text-xl md:text-2xl font-bold mb-6">feedback</h2>
                
                <div class="mb-6">
                    <p class="mb-3 text-sm md:text-base">1. Did the system detect the image correctly?</p>
                    <div class="bg-gray-900/50 rounded-lg p-2 flex gap-2">
                        <button data-value="Yes" class="feedback-yn-btn flex-1 bg-transparent hover:bg-gray-700 rounded-md py-2 transition-colors flex justify-center items-center text-sm md:text-base" aria-label="Yes">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6" fill="none" viewBox="0 0 24 24" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                        </button>
                        <button data-value="No" class="feedback-yn-btn flex-1 bg-transparent hover:bg-gray-700 rounded-md py-2 transition-colors flex justify-center items-center text-sm md:text-base" aria-label="No">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6" fill="none" viewBox="0 0 24 24" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <p class="mb-3 text-sm md:text-base">2. How satisfied are you with the detection performance of the system?</p>
                    <div id="star-rating" class="flex justify-start text-3xl md:text-4xl cursor-pointer gap-2">
                        <span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
                    </div>
                </div>

                <div class="mb-6">
                    <p class="mb-3 text-sm md:text-base">3. What suggestions do you have to enhance the performance of the system?</p>
                    <div class="relative">
                        <textarea id="feedback-textarea" class="w-full bg-gray-900/50 rounded-lg p-3 h-20 md:h-24 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm md:text-base" maxlength="100"></textarea>
                        <span id="char-counter" class="absolute bottom-2 right-3 text-xs text-gray-400">0/100</span>
                    </div>
                </div>
              </div>
              <button id="send-feedback-btn" class="mt-4 font-bold py-2 px-6 rounded-lg text-sm md:text-base" disabled>Send</button>
        </div>
    </div>
    
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your web app's Firebase configuration from your project
        const firebaseConfig = {
            apiKey: "AIzaSyAC2oR06g1UlLg4S-Fz1vvwyDAvB7knXY0",
            authDomain: "dfi-feedback.firebaseapp.com",
            projectId: "dfi-feedback",
            storageBucket: "dfi-feedback.firebasestorage.app",
            messagingSenderId: "30723774344",
            appId: "1:30723774344:web:125332a5ca36a149ea0c3d",
            measurementId: "G-RB732G48VC"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const db = getFirestore(app);
            // Make db and Firestore functions globally accessible
            window.db = db;
            window.firebaseTools = { collection, addDoc, serverTimestamp };
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Error initializing Firebase. Please check your firebaseConfig.", e);
            alert("Could not connect to the database. Please check the console for errors.");
        }
    </script>
    
    <script type="module">
    // --- JavaScript for Animated Background ---
    const canvas = document.getElementById('bg-canvas');
    if (canvas) {
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;
        class Particle {
            constructor(x, y, size, color, speedX, speedY) { this.x = x; this.y = y; this.size = size; this.color = color; this.speedX = speedX; this.speedY = speedY; }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = this.color; ctx.fill(); }
            update() { if (this.x + this.size > canvas.width || this.x - this.size < 0) { this.speedX = -this.speedX; } if (this.y + this.size > canvas.height || this.y - this.size < 0) { this.speedY = -this.speedY; } this.x += this.speedX; this.y += this.speedY; this.draw(); }
        }
        function init() {
            particlesArray = [];
            let numberOfParticles = (canvas.height * canvas.width) / 12000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 2) + 1;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let speedX = (Math.random() * 0.4) - 0.2;
                let speedY = (Math.random() * 0.4) - 0.2;
                let color = `rgba(86, 204, 242, 0.8)`;
                particlesArray.push(new Particle(x, y, size, color, speedX, speedY));
            }
        }

        function connect() {
            let opacityValue = 1;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x))
                                 + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
                    
                    if (distance < (canvas.width/7) * (canvas.height/7)) {
                        opacityValue = 1 - (distance/20000);
                        ctx.strokeStyle = `rgba(86, 204, 242, ${opacityValue})`;
                        ctx.lineWidth = 0.2;
                        ctx.beginPath();
                        ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                        ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                        ctx.stroke();
                    }
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (ctx) { 
                ctx.clearRect(0, 0, innerWidth, innerHeight); 
                for (let i = 0; i < particlesArray.length; i++) { 
                    particlesArray[i].update(); 
                }
                connect();
            }
        }
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; init(); });
        init();
        animate();
    }

    // --- Result Page Logic (Updated) ---
    document.addEventListener('DOMContentLoaded', () => {
        const resultDataString = localStorage.getItem('detectionResult');
        const imageSrc = localStorage.getItem('imageSrc');
        const resultWrapper = document.getElementById('result-wrapper');

        if (!resultDataString || !imageSrc) {
            resultWrapper.innerHTML = '<h2 class="text-red-400 text-2xl font-bold text-center col-span-full">ไม่พบข้อมูลผลลัพธ์ กรุณากลับไปหน้าอัปโหลด</h2>';
            setTimeout(() => {
                window.location.href = 'image Detection.html';
            }, 3000);
            return;
        }

        // --- DOM Elements ---
        document.getElementById('final-image').src = imageSrc;
        
        // --- Process and Display Results ---
        try {
            const data = JSON.parse(resultDataString);
            
            if (data.prediction && data.predicted_class && data.feature_breakdown) {
                displayNewApiResults(data);
            } else if (data.predictions) {
                displayOldApiResults(data);
            } else {
                throw new Error("รูปแบบข้อมูล API ไม่ถูกต้อง");
            }

        } catch (error) {
              resultWrapper.innerHTML = `<h2 class="text-red-400 text-2xl font-bold text-center col-span-full">เกิดข้อผิดพลาดในการแสดงผล: ${error.message}</h2>`;
        }
        
        // --- UI Update Function for NEW API Data ---
        function displayNewApiResults(data) {
            const { prediction, predicted_class, feature_breakdown } = data;
            const isFake = predicted_class === 'Fake';
            const mainPercentage = Math.round(isFake ? prediction.fake : prediction.real);
            const primaryColor = isFake ? '#ff4d6d' : '#2ecc71';

            let breakdownHTML = '';
            for (const [key, value] of Object.entries(feature_breakdown)) {
                if (key.toLowerCase().includes('total')) continue;
                const percentageValue = value.toFixed(2);
                breakdownHTML += `
                    <div class="w-full">
                        <div class="flex justify-between mb-1"><span class="text-xs md:text-sm font-medium text-gray-300">${key}</span><span class="text-xs md:text-sm font-bold text-white">${percentageValue}%</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5"><div class="h-2.5 rounded-full" style="width: ${percentageValue}%; background-color: ${primaryColor};"></div></div>
                    </div>`;
            }

            document.getElementById('result-details').innerHTML = `
                <div class="flex flex-col items-center w-full">
                    <div class="px-4 py-6 md:px-10 rounded-2xl w-full space-y-6 flex flex-col items-center">
                        <div class="circular-progress" style="--progress-value: ${mainPercentage}; --progress-color: ${primaryColor};"><span class="progress-value">${mainPercentage}%</span></div>
                        <h2 class="text-3xl md:text-4xl font-bold" style="color: ${primaryColor}; text-shadow: 0 0 15px ${primaryColor}, 0 0 25px ${primaryColor};">${predicted_class.toUpperCase()}</h2>
                        <div class="w-full space-y-4">${breakdownHTML}</div>
                    </div>
                </div>`;
        }
        
        // --- UI Update Function for OLD API Data (Fallback) ---
        function displayOldApiResults(data) {
            const aiPrediction = data.predictions.find(p => p.label === 'AI-Generated');
            const fakeConfidence = aiPrediction ? aiPrediction.confidence : 0;
            const fakePercentage = Math.round(fakeConfidence * 100);
            const isFake = fakePercentage > 50;
            const predictedClass = isFake ? 'Fake' : 'Real';
            const primaryColor = isFake ? '#ff4d6d' : '#2ecc71';

            let breakdown = {};
            if (isFake) {
                breakdown['Texture Artifacts'] = Math.min(95, Math.round(Math.random() * (fakePercentage * 0.4) + 15));
                breakdown['Bounding Box / Outline'] = Math.min(95, Math.round(Math.random() * (fakePercentage * 0.5) + 10));
                breakdown['Noise'] = Math.min(95, Math.round(Math.random() * (fakePercentage * 0.3)));
                breakdown['Light & shadow'] = Math.min(95, Math.round(Math.random() * (fakePercentage * 0.2)));
            } else {
                breakdown['Texture Artifacts'] = Math.round(Math.random() * 15);
                breakdown['Bounding Box / Outline'] = Math.round(Math.random() * 10);
                breakdown['Noise'] = Math.round(Math.random() * 12);
                breakdown['Light & shadow'] = Math.round(Math.random() * 8);
            }

            let breakdownHTML = '';
            for (const [key, value] of Object.entries(breakdown)) {
                breakdownHTML += `
                    <div class="w-full">
                        <div class="flex justify-between mb-1"><span class="text-xs md:text-sm font-medium text-gray-300">${key}</span><span class="text-xs md:text-sm font-bold text-white">${value}%</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5"><div class="h-2.5 rounded-full" style="width: ${value}%; background-color: ${primaryColor};"></div></div>
                    </div>`;
            }

            document.getElementById('result-details').innerHTML = `
                <div class="flex flex-col items-center w-full">
                    <div class="px-4 py-6 md:px-10 rounded-2xl w-full space-y-6 flex flex-col items-center">
                        <div class="circular-progress" style="--progress-value: ${fakePercentage}; --progress-color: ${primaryColor};"><span class="progress-value">${fakePercentage}%</span></div>
                        <h2 class="text-3xl md:text-4xl font-bold" style="color: ${primaryColor}; text-shadow: 0 0 15px ${primaryColor}, 0 0 25px ${primaryColor};">${predictedClass.toUpperCase()}</h2>
                        <div class="w-full space-y-4">${breakdownHTML}</div>
                    </div>
                </div>`;
        }

        // --- Feedback Modal Logic ---
        const feedbackModal = document.getElementById('feedback-modal');
        const sendFeedbackBtn = document.getElementById('send-feedback-btn');
        const ynButtons = document.querySelectorAll('.feedback-yn-btn');
        const stars = document.querySelectorAll('#star-rating span');
        const feedbackTextarea = document.getElementById('feedback-textarea');
        const charCounter = document.getElementById('char-counter');
        const navLinks = document.querySelectorAll('header a');
        const checkAnotherBtn = document.getElementById('check-another-btn');
        
        let navigationUrl = null;

        function sanitizeInput(input) {
            const temp = document.createElement('div');
            temp.textContent = input;
            return temp.innerHTML;
        }

        function validateFeedbackForm() {
            const isCorrectlyDetected = document.querySelector('.feedback-yn-btn.active') !== null;
            const isRated = document.querySelectorAll('#star-rating span.active').length > 0;
            const hasSuggestion = feedbackTextarea.value.trim() !== '';

            sendFeedbackBtn.disabled = !(isCorrectlyDetected && isRated && hasSuggestion);
        }

        function triggerFeedback(url) {
            navigationUrl = url;
            feedbackModal.classList.remove('hidden');
            feedbackModal.classList.add('flex');
            validateFeedbackForm();
        }

        checkAnotherBtn.addEventListener('click', () => {
            triggerFeedback('image-detection.html');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                triggerFeedback(link.href);
            });
        });

        sendFeedbackBtn.addEventListener('click', async () => {
            // Check if Firebase is available
            if (!window.db || !window.firebaseTools) {
                alert("Firebase is not initialized. Please check your configuration.");
                return;
            }

            sendFeedbackBtn.disabled = true;
            sendFeedbackBtn.textContent = 'Sending...';

            const correctDetection = document.querySelector('.feedback-yn-btn.active')?.dataset.value || 'Not answered';
            const rating = document.querySelectorAll('#star-rating span.active').length;
            const suggestion = sanitizeInput(feedbackTextarea.value); // Sanitize input
            const detectionData = JSON.parse(resultDataString || '{}');

            const formData = {
                correct_detection: correctDetection,
                satisfaction_rating: `${rating} / 5`,
                suggestion: suggestion,
                detection_result: JSON.stringify(detectionData),
                createdAt: window.firebaseTools.serverTimestamp()
            };

            try {
                // --- Save to Firestore for the dashboard ---
                const docRef = await window.firebaseTools.addDoc(window.firebaseTools.collection(window.db, "feedback"), formData);
                console.log("Feedback saved to Firestore with ID: ", docRef.id);
                
                // --- Also send to Formspree for backup/notifications ---
                await fetch('https://formspree.io/f/xqadgwqz', {
                    method: 'POST', body: JSON.stringify(formData),
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
                });

            } catch (error) {
                console.error('Error submitting feedback:', error);
            } finally {
                // --- Navigate to the next page ---
                feedbackModal.classList.add('hidden');
                feedbackModal.classList.remove('flex');
                window.location.href = navigationUrl || 'Image Detection.html';
            }
        });

        ynButtons.forEach(button => {
            button.addEventListener('click', () => {
                ynButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                validateFeedbackForm();
            });
        });
        
        stars.forEach((star, index) => {
            star.addEventListener('mouseenter', () => {
                stars.forEach((s, i) => { s.classList.toggle('hovered', i <= index); });
            });
            star.addEventListener('mouseleave', () => {
                stars.forEach(s => s.classList.remove('hovered'));
            });
            star.addEventListener('click', () => {
                stars.forEach((s, i) => {
                    s.classList.remove('active');
                    if (i <= index) {
                        s.classList.add('active');
                    }
                });
                validateFeedbackForm();
            });
        });

        feedbackTextarea.addEventListener('input', () => {
            charCounter.textContent = `${feedbackTextarea.value.length}/100`;
            validateFeedbackForm();
        });
    });
    </script>
</body>
</html>