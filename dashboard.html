<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFI - Feedback Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        
        html, body {
            height: 100%;
            overflow: hidden; 
        }
        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            background-color: #05040d;
            color: white;
            display: flex;
            flex-direction: column;
        }
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: linear-gradient(to right bottom, #05040d, #06050f, #080611, #090813, #0a0915, #0b0a17, #0c0b19, #0d0c1b, #0f0d1d, #100e1f, #110f21, #121023);
        }
        
        /* Header Styles - ADJUSTED FOR FULL TEXT ON MOBILE */
        header {
            display: flex; justify-content: space-between; color: white; align-items: center;
            padding: 10px 10px; 
            position: relative; z-index: 1;
            flex-shrink: 0;
        }
        .logo img { height: 80px; width: auto; } 
        .nav-menu { 
            display: flex; 
            align-items: center; 
            gap: 5px;
            flex-wrap: nowrap; 
        } 
        .nav-menu nav { margin-top: 0; } 

        .nav-menu nav a { 
            margin: 0 3px; 
            color: #ffffff; 
            text-decoration: none; 
            
            font-size: 0.65rem; 
            white-space: nowrap; 
            padding: 5px 3px; 
        } 

        .nav-menu nav a.active { font-weight: bold; }

        /* Media query for PC/Desktop adjustments */
        @media (min-width: 768px) {
            header {
                padding: 0px 50px 20px 70px; 
            }
            .logo img { height: 130px; width: auto; } 
            .nav-menu { gap: 20px; } 
            .nav-menu nav { margin-top: 8px; } 
            .nav-menu nav a { margin: 0 10px; font-size: 1rem; } /* Full size on PC */
        }

        /* Main Content Styles */
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
            min-height: 0;
            animation: fadeIn 0.8s ease-out forwards;
            margin-top: -20px;
        }
        
        /* Card Styles (Unchanged) */
        .card {
              background-color: rgba(255, 255, 255, 0.05);
              backdrop-filter: blur(10px);
              border: 1px solid rgba(255, 255, 255, 0.1);
              transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            border-color: rgba(86, 204, 242, 0.3);
        }
        .suggestions-list::-webkit-scrollbar { width: 6px; }
        .suggestions-list::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 10px; }

        /* Keyframe (Unchanged) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stat Card Icon (Unchanged) */
        .stat-card-icon {
            position: absolute;
            top: -1.25rem;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #1e293b, #475569);
            border-radius: 50%;
            padding: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .stat-card-icon svg {
            width: 1.5rem;
            height: 1.5rem;
            color: #94a3b8;
        }

        /* Suggestion Item (Unchanged) */
        .suggestion-item {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid #2f80ed;
            padding: 0.75rem 1rem;
            border-radius: 0 8px 8px 0;
            transition: background-color 0.3s;
        }
        .suggestion-item:hover {
            background: rgba(86, 204, 242, 0.1);
        }

    </style>
</head>
<body class="h-screen flex flex-col">
    <canvas id="bg-canvas"></canvas>
    
    <header>
        <a href="index.html">
            <div class="logo">
                <img src="imge/Logo 1.png" alt="DFI Logo" onerror="this.onerror=null;this.src='https://placehold.co/200x80/0f0c1f/ffffff?text=DFI';">
            </div>
        </a>
        <div class="nav-menu">
            <nav>
                <a href="introduction.html">Introduction</a> 
                <a href="image-detection.html">Image Detection</a> 
                <a href="dashboard.html" class="active">Dashboard</a>
                <a href="about us.html">About Us</a> 
            </nav>
        </div>
    </header>

    <main class="w-full p-4 md:px-6 pb-8"> 
        <div class="max-w-screen-xl mx-auto w-full flex flex-col">
            <div class="flex justify-center items-center mb-2">
                <h1 class="text-3xl md:text-4xl font-bold text-white text-center" style="text-shadow: 0 0 8px rgba(86, 204, 242, 0.8), 0 0 20px rgba(47, 128, 237, 0.6);">Feedback Dashboard</h1>
            </div>
            
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-4 mt-4 md:mt-8">
                <div class="card relative rounded-2xl p-4 pt-9 text-center">
                    <div class="stat-card-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" /></svg>
                    </div>
                    <h2 class="text-xs md:text-sm text-gray-400 mb-1">Total Feedbacks</h2> <p id="total-feedback" class="text-2xl md:text-3xl font-bold text-white">0</p> </div>
                <div class="card relative rounded-2xl p-4 pt-9 text-center">
                    <div class="stat-card-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>
                    </div>
                    <h2 class="text-xs md:text-sm text-gray-400 mb-1">Average Rating (5 Stars)</h2>
                    <p id="average-rating" class="text-2xl md:text-3xl font-bold text-yellow-400">0.0</p>
                </div>
                <div class="card relative rounded-2xl p-4 pt-9 text-center col-span-2 lg:col-span-1"> <div class="stat-card-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" /></svg>
                    </div>
                    <h2 class="text-xs md:text-sm text-gray-400 mb-1">Detection Accuracy (100%)</h2>
                    <p id="detection-accuracy" class="text-2xl md:text-3xl font-bold text-green-400">0%</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 min-h-0">
                <!-- Pie Chart: Reduced width to 1/3 (lg:col-span-1) -->
                <div class="lg:col-span-1 flex flex-col">
                    <div class="card rounded-2xl p-4 flex flex-col h-72 md:h-72">
                        <h3 class="text-base font-bold mb-2">Satisfaction Ratings</h3>
                        <div class="relative flex-grow flex justify-center items-center">
                            <div class="relative h-48 w-48 md:h-56 md:w-56">
                                <canvas id="satisfactionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Suggestions: Increased width to 2/3 (lg:col-span-2) -->
                <div class="lg:col-span-2 flex flex-col">
                    <div class="card rounded-2xl p-4 flex flex-col h-72 md:h-72">
                        <h3 class="text-base font-bold mb-2">User Suggestions</h3>
                        <div id="suggestions-list" class="suggestions-list space-y-3 overflow-y-auto flex-1 pr-2">
                            <p class="text-gray-400 text-center mt-8">No feedback submitted yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAC2oR06g1UlLg4S-Fz1vvwyDAvB7knXY0",
            authDomain: "dfi-feedback.firebaseapp.com",
            projectId: "dfi-feedback",
            storageBucket: "dfi-feedback.firebasestorage.app",
            messagingSenderId: "30723774344",
            appId: "1:30723774344:web:125332a5ca36a149ea0c3d",
            measurementId: "G-RB732G48VC"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const db = getFirestore(app);
            window.db = db;
            window.firebaseTools = { collection, onSnapshot, query, orderBy };
            console.log("Firebase initialized successfully for Dashboard.");
        } catch(e) {
            console.error("Error initializing Firebase. Please check your firebaseConfig.", e);
            
        }
    </script>

    <script type="module">
    // --- Animated Background (Unchanged) ---
    const canvas = document.getElementById('bg-canvas');
    if (canvas) {
        const ctx = canvas.getContext('2d'); canvas.width = window.innerWidth; canvas.height = window.innerHeight; let particlesArray; class Particle { constructor(x, y, size, color, speedX, speedY) { this.x = x; this.y = y; this.size = size; this.color = color; this.speedX = speedX; this.speedY = speedY; } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = this.color; ctx.fill(); } update() { if (this.x + this.size > canvas.width || this.x - this.size < 0) { this.speedX = -this.speedX; } if (this.y + this.size > canvas.height || this.y - this.size < 0) { this.speedY = -this.speedY; } this.x += this.speedX; this.y += this.speedY; this.draw(); } } function init() { particlesArray = []; let numberOfParticles = (canvas.height * canvas.width) / 12000; for (let i = 0; i < numberOfParticles; i++) { let size = (Math.random() * 2) + 1; let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2); let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2); let speedX = (Math.random() * 0.4) - 0.2; let speedY = (Math.random() * 0.4) - 0.2; let color = `rgba(86, 204, 242, 0.8)`; particlesArray.push(new Particle(x, y, size, color, speedX, speedY)); } } function connect() { let opacityValue = 1; for (let a = 0; a < particlesArray.length; a++) { for (let b = a; b < particlesArray.length; b++) { let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y)); if (distance < (canvas.width/7) * (canvas.height/7)) { opacityValue = 1 - (distance/20000); ctx.strokeStyle = `rgba(86, 204, 242, ${opacityValue})`; ctx.lineWidth = 0.2; ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke(); } } } } function animate() { requestAnimationFrame(animate); if (ctx) { ctx.clearRect(0, 0, innerWidth, innerHeight); for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); } connect(); } } window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; init(); }); init(); animate();
    }

    // --- Dashboard Logic using Firebase (MODIFIED FOR PIE CHART) ---
    document.addEventListener('DOMContentLoaded', () => {
        let satisfactionChartInstance = null;

        function processAndDisplayData(submissions) {
            const suggestionsList = document.getElementById('suggestions-list');
            suggestionsList.innerHTML = '';

            if (!submissions || submissions.length === 0) {
                 document.getElementById('total-feedback').textContent = '0';
                 document.getElementById('average-rating').textContent = `0.0`;
                 document.getElementById('detection-accuracy').textContent = `0%`;
                 suggestionsList.innerHTML = '<p class="text-gray-400 text-center mt-8">No feedback submitted yet.</p>';
                 if (satisfactionChartInstance) {
                     satisfactionChartInstance.destroy();
                     satisfactionChartInstance = null;
                 }
                 return;
            };

            let totalRatings = 0;
            let correctDetections = 0;
            const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

            submissions.forEach(sub => {
                const rating = parseInt(sub.satisfaction_rating.split(' ')[0]);
                if (!isNaN(rating)) {
                    totalRatings += rating;
                    if (ratingCounts[rating] !== undefined) ratingCounts[rating]++;
                }
                if (sub.correct_detection === "Yes") correctDetections++;
                if (sub.suggestion && sub.suggestion.trim()) {
                    const suggestionEl = document.createElement('div');
                    suggestionEl.className = 'suggestion-item';
                    suggestionEl.textContent = `“${sub.suggestion}”`;
                    suggestionsList.append(suggestionEl);
                }
            });

            const totalFeedback = submissions.length;
            document.getElementById('total-feedback').textContent = totalFeedback;
            // *** MODIFIED LINE: Removed ' ★' (star symbol) ***
            document.getElementById('average-rating').textContent = `${(totalRatings / totalFeedback).toFixed(1)}`; 
            document.getElementById('detection-accuracy').textContent = `${((correctDetections / totalFeedback) * 100).toFixed(0)}%`;
            
            if (suggestionsList.innerHTML === '') {
                suggestionsList.innerHTML = '<p class="text-gray-400 text-center mt-8">No suggestions with text submitted.</p>';
            }

            // --- *** START OF CHART MODIFICATION *** ---
            if (satisfactionChartInstance) {
                satisfactionChartInstance.destroy();
            }
            const satisfactionCtx = document.getElementById('satisfactionChart').getContext('2d');
            // Removed gradient, as we need distinct colors for pie chart

            satisfactionChartInstance = new Chart(satisfactionCtx, {
                type: 'pie', 
                data: {
                    labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                    datasets: [{
                        label: '# of Votes',
                        data: Object.values(ratingCounts).reverse(),
                        backgroundColor: [ // <-- CHANGED to array of colors
                            'rgba(86, 204, 242, 0.8)', // 5 Stars
                            'rgba(47, 128, 237, 0.8)',  // 4 Stars
                            'rgba(250, 204, 21, 0.8)',  // 3 Stars
                            'rgba(249, 115, 22, 0.8)',  // 2 Stars
                            'rgba(220, 38, 38, 0.8)'   // 1 Star
                        ],
                        borderColor: '#05040d', 
                        borderWidth: 2,
                        
                    }]
                },
                options: {
                    
                    maintainAspectRatio: false,
                    responsive: true, 
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#9ca3af',
                                boxWidth: 12, 
                                padding: 8    
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(5, 4, 13, 0.8)', backdropFilter: 'blur(5px)', titleColor: '#ffffff',
                            bodyColor: '#e5e7eb', borderColor: 'rgba(86, 204, 242, 0.5)', borderWidth: 1, padding: 10,
                            cornerRadius: 8, 
                            displayColors: true, 
                            callbacks: {
                                label: function(context) { 
                                    let label = context.label || '';
                                    let value = context.parsed || 0;
                                    return `${label}: ${value} vote(s)`;
                                }
                            }
                        }
                    }
                }
            });
            // --- *** END OF CHART MODIFICATION *** ---
        }
        
        // --- Listen for real-time updates from Firestore (Unchanged) ---
        function listenForFeedback() {
             if (!window.db || !window.firebaseTools) {
                 console.warn("Firebase not ready yet, trying again in 100ms...");
                 setTimeout(listenForFeedback, 100);
                 return;
             }
             const { collection, query, orderBy, onSnapshot } = window.firebaseTools;
             const feedbackQuery = query(collection(window.db, "feedback"), orderBy("createdAt", "desc"));
             
             onSnapshot(feedbackQuery, (querySnapshot) => {
                 const submissions = [];
                 querySnapshot.forEach((doc) => {
                     submissions.push(doc.data());
                 });
                 processAndDisplayData(submissions);
             });
         }

        listenForFeedback();

    });
    </script>
</body>
</html>